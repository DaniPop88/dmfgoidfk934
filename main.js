"use strict";const BACKEND_URL="https://redepop-backend.onrender.com",MANIFEST_URL=window.REDEPOP_MANIFEST_URL||"./manifest.json",VALIDATION_DEBOUNCE_MS=500,VALIDATION_CACHE_DURATION_MS=3e5,REQUEST_TIMEOUT_MS=1e4,COLOR_SCHEMES=[{primary:"#8B5CF6",secondary:"#6D28D9"}],validationCache=new Map;let validationDebounceTimer=null,currentValidationController=null;function getCachedValidation(e,t){let r=`${e}:${t}`,a=validationCache.get(r);return a&&Date.now()-a.timestamp<3e5?a.result:null}function setCachedValidation(e,t,r){let a=`${e}:${t}`;if(validationCache.set(a,{result:r,timestamp:Date.now()}),validationCache.size>100){let o=validationCache.keys().next().value;validationCache.delete(o)}}async function validateSecretCode(e,t){let r=getCachedValidation(e,t);if(r)return console.log("✅ Using cached validation result"),r;currentValidationController&&currentValidationController.abort(),currentValidationController=new AbortController;let a=currentValidationController.signal;try{let o=new Promise((e,t)=>setTimeout(()=>t(Error("Timeout")),1e4)),n=fetch(`${BACKEND_URL}/validate?product_id=${encodeURIComponent(e)}&secret_code=${encodeURIComponent(t)}`,{signal:a}),d=await Promise.race([n,o]),l=await d.json();return setCachedValidation(e,t,l),l}catch(i){if("AbortError"===i.name)throw console.log("❌ Request cancelled"),Error("cancelled");throw i}}function shuffleArray(e){let t=[...e];for(let r=t.length-1;r>0;r--){let a=Math.floor(Math.random()*(r+1));[t[r],t[a]]=[t[a],t[r]]}return t}function setRandomColorScheme(){document.documentElement.style.setProperty("--dynamic-primary","#8B5CF6"),document.documentElement.style.setProperty("--dynamic-secondary","#6D28D9"),document.documentElement.style.setProperty("--dynamic-gradient","linear-gradient(135deg, #8B5CF6, #6D28D9)")}function createIntersectionObserver(){return new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){let t=e.target;t.dataset.src&&(t.classList.add("loading"),t.src=t.dataset.src,t.onload=()=>{t.classList.remove("loading"),t.classList.add("loaded")},t.removeAttribute("data-src"))}})},{rootMargin:"50px",threshold:.1})}const orderModal=document.getElementById("orderModal"),orderModalCloseBtn=document.getElementById("orderModalCloseBtn"),orderForm=document.getElementById("orderForm"),orderSubmitBtn=document.getElementById("orderSubmitBtn"),orderFormMessage=document.getElementById("orderFormMessage"),catalog=document.getElementById("catalog"),loadingOverlay=document.getElementById("loadingOverlay");let platformSelect,gameIdInput;function updateOrderProductInfo(e,t,r){document.getElementById("orderProductName").textContent=e||"",document.getElementById("orderProductImg").src=t||"",document.getElementById("orderProductId").value=r||""}function el(e,t,r={}){let a=document.createElement(e);for(let[o,n]of(t&&(a.className=t),Object.entries(r)))"text"===o?a.textContent=n:"html"===o?a.innerHTML=n:a.setAttribute(o,n);return a}function buildProductCard({src:e,name:t,secret:r,isExtra:a,isFeatured:o},n){let d=`product-card${a?" extra-product":""}${o?" featured":""}`,l=el("div",d,{"data-secret":r});if(l.style.animationDelay=`${.1*n}s`,o){let i=el("div","featured-badge",{text:"⭐"});l.appendChild(i)}let s=el("img","product-img",{src:e,alt:t,loading:n>5?"lazy":"eager",fetchpriority:n<3?"high":"auto",width:"250",height:"250"}),c=el("div","product-name",{text:t});return l.appendChild(s),l.appendChild(c),a&&(l.hidden=!0),l}function buildTierSection(e,t){let r=el("section","reward-tier",{"data-tier":e.id}),a=parseInt(e.id.split("-")[1])||1;r.style.animationDelay=`${.2*a}s`;let o=el("div","tier-header",{text:e.label||e.id});r.appendChild(o);let n=el("div","product-grid");r.appendChild(n);let d=Number.isInteger(e.showFirst)?e.showFirst:6,l=Array.isArray(e.items)?e.items:[],i=l.filter(e=>e.pinned),s=l.filter(e=>!e.pinned);l=[...i,...s=shuffleArray(s)];let c=Math.min(d,l.length),m=Math.floor(2*Math.random())+1,u=new Set;for(;u.size<Math.min(m,c);)u.add(Math.floor(Math.random()*c));if(l.forEach((r,a)=>{let o=r.url?r.url:t+r.file,l=r.name||r.file||r.url||"Produto",i=a>=d,s=u.has(a)&&!i,c=buildProductCard({src:o,name:l,secret:e.id,isExtra:i,isFeatured:s},a);n.appendChild(c)}),l.length>d){let g=el("button","veja-mais-btn",{"data-tier":e.id});g.appendChild(el("span","btn-text",{text:"VEJA MAIS"})),g.appendChild(el("span","arrow-icon",{html:"&#9660;"})),r.appendChild(g)}return r}async function loadCatalog(){try{setRandomColorScheme(),loadingOverlay&&(loadingOverlay.style.display="flex");let e=await fetch(MANIFEST_URL,{cache:"force-cache"});if(!e.ok)throw Error(`HTTP ${e.status}`);let t=await e.json(),r=(t.baseUrl||"").trim(),a=Array.isArray(t.tiers)?t.tiers:[];catalog.innerHTML="",a.forEach(e=>{let t=buildTierSection(e,r);catalog.appendChild(t)}),loadingOverlay&&(loadingOverlay.classList.add("hidden"),setTimeout(()=>{loadingOverlay.style.display="none"},500))}catch(o){console.error("Gagal memuat manifest:",o),catalog.innerHTML='<p style="color:#8B5CF6;text-align:center;padding:20px;">Falha ao carregar cat\xe1logo. Tente novamente mais tarde.</p>',loadingOverlay&&(loadingOverlay.classList.add("hidden"),setTimeout(()=>{loadingOverlay.style.display="none"},500))}}document.addEventListener("click",e=>{let t=e.target.closest(".product-card");if(t&&!t.hidden){let r=t.querySelector(".product-name").textContent,a=t.querySelector(".product-img").src||t.querySelector(".product-img").dataset.src,o=t.dataset.secret;updateOrderProductInfo(r,a,o),orderModal.classList.add("active")}}),document.addEventListener("click",e=>{let t=e.target.closest(".veja-mais-btn");if(t){let r=t.dataset.tier,a=document.querySelector(`[data-tier="${r}"] .product-grid`),o=a.querySelectorAll(".product-card.extra-product"),n=Array.from(o).every(e=>!e.hidden);n?(o.forEach(e=>{e.hidden=!0}),t.querySelector(".btn-text").textContent="VEJA MAIS",t.querySelector(".arrow-icon").innerHTML="&#9660;"):(o.forEach(e=>{e.hidden=!1}),t.querySelector(".btn-text").textContent="VEJA MENOS",t.querySelector(".arrow-icon").innerHTML="&#9650;")}}),orderModalCloseBtn&&orderModalCloseBtn.addEventListener("click",()=>{orderModal.classList.remove("active")}),orderModal&&orderModal.addEventListener("click",e=>{e.target===orderModal&&orderModal.classList.remove("active")});let isCPFValid=!1;function validateCPF(e){let t=e.replace(/\D/g,"");if(11!==t.length||/^(\d)\1{10}$/.test(t))return!1;let r=0;for(let a=0;a<9;a++)r+=parseInt(t[a])*(10-a);let o=10*r%11;if(10===o&&(o=0),o!==parseInt(t[9]))return!1;r=0;for(let n=0;n<10;n++)r+=parseInt(t[n])*(11-n);let d=10*r%11;return 10===d&&(d=0),d===parseInt(t[10])}function applyGameIdRules(){if(!platformSelect||!gameIdInput)return;let e=platformSelect.value;"POPN1"===e?(gameIdInput.placeholder="Ex. 123456789012 (12 d\xedgitos)",gameIdInput.maxLength=12):(gameIdInput.placeholder="Selecione a plataforma para ver o formato",gameIdInput.maxLength=12)}function validateGameId(){if(!platformSelect||!gameIdInput)return!1;let e=platformSelect.value,t=gameIdInput.value.trim();return"POPN1"===e&&/^\d{12}$/.test(t)}let isSecretCodeValid=!1;const secretCodeInput=document.getElementById("secretCode"),secretCodeStatus=document.getElementById("secretCodeStatus");function showSpinner(){secretCodeStatus&&(secretCodeStatus.innerHTML=`
    <svg viewBox="0 0 50 50" style="width:20px;height:20px;animation:spin 1s linear infinite">
      <circle cx="25" cy="25" r="20" fill="none" stroke="#8B5CF6" stroke-width="4" stroke-dasharray="31.415 31.415" stroke-linecap="round">
      </circle>
    </svg>
  `)}function showCheck(){secretCodeStatus&&(secretCodeStatus.innerHTML='<ion-icon name="checkmark-circle" style="color:#28c650;font-size:1.6em"></ion-icon>')}function showWarning(){secretCodeStatus&&(secretCodeStatus.innerHTML='<ion-icon name="warning" style="color:#F59E0B;font-size:1.6em"></ion-icon>')}function clearStatus(){secretCodeStatus&&(secretCodeStatus.innerHTML="")}function updateOrderSubmitBtn(){orderSubmitBtn&&orderForm&&(orderSubmitBtn.disabled=!(orderForm.checkValidity()&&isCPFValid&&isSecretCodeValid))}secretCodeInput&&secretCodeInput.addEventListener("input",function(){let e=this.value.trim(),t=document.getElementById("orderProductId").value;if(isSecretCodeValid=!1,updateOrderSubmitBtn(),validationDebounceTimer&&clearTimeout(validationDebounceTimer),e.length<=4){isSecretCodeValid=!1,orderFormMessage.textContent="",clearStatus(),updateOrderSubmitBtn();return}if(!t){orderFormMessage.textContent="Selecione um produto primeiro",orderFormMessage.style.color="#F59E0B",clearStatus();return}orderFormMessage.textContent="Preparando valida\xe7\xe3o...",orderFormMessage.style.color="#2D1B4E",showSpinner(),validationDebounceTimer=setTimeout(async()=>{orderFormMessage.textContent="Validando c\xf3digo...";try{let r=await validateSecretCode(t,e);"valid"===r.status?(isSecretCodeValid=!0,orderFormMessage.textContent="✓ C\xf3digo v\xe1lido! Voc\xea pode enviar.",orderFormMessage.style.color="#28c650",showCheck()):"used"===r.status?(isSecretCodeValid=!1,orderFormMessage.textContent="⚠️ C\xf3digo j\xe1 foi utilizado!",orderFormMessage.style.color="#F59E0B",showWarning()):(isSecretCodeValid=!1,orderFormMessage.textContent="✗ C\xf3digo inv\xe1lido!",orderFormMessage.style.color="#F59E0B",showWarning())}catch(a){if("cancelled"===a.message)return;isSecretCodeValid=!1,"Timeout"===a.message?orderFormMessage.textContent="⏱️ Conex\xe3o lenta. Tente novamente.":orderFormMessage.textContent="❌ Erro ao validar. Tente novamente.",orderFormMessage.style.color="#F59E0B",showWarning()}updateOrderSubmitBtn()},500)}),orderForm&&orderForm.addEventListener("submit",async function(e){if(e.preventDefault(),!orderForm.checkValidity()||!isCPFValid||!isSecretCodeValid){orderForm.reportValidity(),orderFormMessage.textContent="Verifique os campos e tente novamente.",orderFormMessage.style.color="#F59E0B",orderSubmitBtn.disabled=!1;return}orderSubmitBtn.disabled=!0,orderFormMessage.textContent="Enviando pedido...",orderFormMessage.style.color="#2D1B4E";let t=document.getElementById("orderProductName").textContent.trim(),r=document.getElementById("orderProductImg").src;if(!t){orderFormMessage.textContent="Erro: Produto n\xe3o detectado.",orderFormMessage.style.color="#F59E0B",orderSubmitBtn.disabled=!1;return}let a={productId:document.getElementById("orderProductId").value,productName:t,productImg:r,fullName:document.getElementById("fullName").value.trim(),phone:document.getElementById("phone").value.trim(),zip:document.getElementById("zip").value.trim(),state:document.getElementById("state").value,city:document.getElementById("city").value,address:document.getElementById("address").value.trim(),neighborhood:document.getElementById("neighborhood").value.trim(),street:document.getElementById("street").value.trim(),number:document.getElementById("number").value.trim(),platform:document.getElementById("platform").value,gameId:document.getElementById("gameId").value.trim(),cpf:document.getElementById("cpf").value.trim(),secretCode:document.getElementById("secretCode").value.trim()};try{let o=new AbortController,n=setTimeout(()=>o.abort(),3e4),d=await fetch(`${BACKEND_URL}/order`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),signal:o.signal});clearTimeout(n);let l=await d.json();if("success"===l.status){let i=`${a.productId}:${a.secretCode}`;validationCache.delete(i);let s=new URL("confirmation.html",window.location.href);s.searchParams.set("productImg",a.productImg),s.searchParams.set("productName",a.productName),s.searchParams.set("secretCode",a.secretCode),s.searchParams.set("fullName",a.fullName),s.searchParams.set("cpf",a.cpf),s.searchParams.set("phone",a.phone),s.searchParams.set("platform",a.platform),s.searchParams.set("gameId",a.gameId),s.searchParams.set("street",a.street),s.searchParams.set("number",a.number),s.searchParams.set("neighborhood",a.neighborhood),s.searchParams.set("city",a.city),s.searchParams.set("state",a.state),s.searchParams.set("zip",a.zip),window.location.href=s.toString()}else orderFormMessage.textContent=l.message||"Erro ao enviar pedido. Tente novamente.",orderFormMessage.style.color="#F59E0B",orderSubmitBtn.disabled=!1}catch(c){console.error("Erro ao enviar pedido:",c),"AbortError"===c.name?orderFormMessage.textContent="⏱️ Tempo esgotado. Verifique sua conex\xe3o e tente novamente.":orderFormMessage.textContent="❌ Erro ao enviar. Verifique sua conex\xe3o.",orderFormMessage.style.color="#F59E0B",orderSubmitBtn.disabled=!1}}),document.addEventListener("DOMContentLoaded",()=>{platformSelect=document.getElementById("platform"),gameIdInput=document.getElementById("gameId");let e=document.getElementById("cpf");if(e){function t(){validateCPF(e.value)?(isCPFValid=!0,"CPF inv\xe1lido!"===orderFormMessage.textContent&&(orderFormMessage.textContent="",orderFormMessage.style.color="")):(isCPFValid=!1,orderFormMessage.textContent="CPF inv\xe1lido!",orderFormMessage.style.color="#F59E0B"),updateOrderSubmitBtn()}e.addEventListener("blur",t),e.addEventListener("input",t)}platformSelect&&platformSelect.addEventListener("change",()=>{applyGameIdRules(),updateOrderSubmitBtn()}),gameIdInput&&gameIdInput.addEventListener("input",()=>{validateGameId(),updateOrderSubmitBtn()}),applyGameIdRules(),loadCatalog()});let ticking=!1;function updateOnScroll(){ticking=!1}document.addEventListener("scroll",()=>{ticking||(requestAnimationFrame(updateOnScroll),ticking=!0)});const criticalImages=["https://i.ibb.co/BHYkmXfs/Whatsapp-Transparent.gif","https://i.ibb.co/s9x87GHJ/Telegram-logo.gif"];criticalImages.forEach(e=>{let t=new Image;t.src=e});